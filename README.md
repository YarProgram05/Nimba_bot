# Nimba_bot

Telegram‑бот для получения отчетов по продажам и остаткам на маркетплейсах, генерации штрихкодов и конвертации CSV в XLSX. Бот ориентирован на работу с Ozon и Wildberries, умеет собирать сводные отчёты по нескольким «кабинетам», настраивать автоматическую рассылку отчётов и генерировать PDF‑этикетки с штрихкодами из Excel.

Содержание
- Описание
- Возможности
- Требования
- Установка и запуск
- Конфигурация (.env)
- Команды и диалоги
- Форматы входных файлов (штрихкоды, CSV)
- Автоотчёты
- Важные файлы и шаблоны
- Рекомендации и известные ограничения
- Развёртывание (Docker / systemd)
- Вклад и лицензия

Описание
--------
Nimba_bot — реализованный на Python Telegram‑бот (используется python-telegram-bot v20+). Он собирает данные из API маркетплейсов (Ozon, Wildberries), агрегирует остатки и продажи, формирует Excel‑отчёты и отправляет их в чат. Также есть утилиты:
- генерация PDF‑этикеток со штрихкодами и упаковка их в ZIP;
- конвертация CSV → XLSX;
- визуальное меню и интерактивная настройка автоотчётов через inline‑кнопки.

Возможности
-----------
- Получение продаж по Ozon и Wildberries (диалог — выбор кабинета и дат).
- Получение остатков по Ozon и Wildberries.
- Формирование объединённого отчёта «Остатки на всех МП» (на основании шаблона Excel).
- Генерация PDF‑этикеток со штрихкодами из Excel (архив zip).
- Конвертация CSV в XLSX с автоопределением кодировки.
- Настройка и планирование автоматических отчетов (job_queue).
- Персистентность диалогов между перезапусками через PicklePersistence.

Требования
----------
- Python 3.9+ (рекомендуется 3.10+)
- Библиотеки перечислены в `requirements.txt`. Основные:
  - python-telegram-bot
  - python-dotenv
  - pandas
  - openpyxl
  - requests
  - reportlab

Команды и диалоги
-----------------
При запуске `/start` бот показывает главное меню с кнопками:
- Продажи Ozon — диалог получения продаж Ozon (выбор кабинета → даты).
- Продажи WB — диалог получения продаж Wildberries.
- Остатки товаров Ozon — выбор кабинета и получение остатков Ozon.
- Остатки товаров WB — выбор кабинета и получение остатков Wildberries.
- Остатки на всех МП — генерирует объединённый отчёт из нескольких кабинетов и отправляет xlsx + сводку.
- Автоотчёты — настройка автоматической ��тправки отчётов (интерактивно через inline-кнопки).
- Генерация штрихкодов — загрузка Excel и генерация PDF‑этикеток (zip).
- Конвертация CSV в XLSX — конвертация CSV файлов в xlsx.

Формат входных файлов: генерация штрихкодов
------------------------------------------
Файл для генерации штрихкодов — Excel (.xlsx) с колонками (ключевые):
- Баркод
- Количество
Опциональные поля (для отрисовки):
- Наименование
- Артикул продавца
- Цвет на бирке
- Размер на бирке
- Состав на бирке
- ИП

После загрузки файла бот попытается сгенерировать PDF‑файлы (этикетки) и упаковать их в `barcodes.zip`, который отправит вам.

Формат входных файлов: CSV → XLSX
--------------------------------
- Бот включает `csv_to_xlsx` с автоопределением кодировки (`utf-8`, `utf-8-sig`, `cp1251` и т.д.). Перед конвертацией бот очищает пустые строки.
- Если кодировка не определена корректно, можно вручную перекодировать файл на стороне клиента.

Автоотчёты
----------
- Конфигурации автоотчётов хранятся в `auto_reports.json`.
- При старте бот вызывает `utils.auto_report_manager.schedule_all_jobs(application)`, чтобы восстановить задачи.
- Вы можете настроить автоотчёт через меню «Автоотчёты»: выбрать тип (пока доступен «Остатки на всех МП»), включить/выключить, выбрать интервал (по часам или по дням), задать время отправки/день недели и дату начала.
- Каждому job при создании передаётся `data={'chat_id': chat_id, 'report_type': report_type}`. Автоотчёт отправляет отчёт в указанный чат.

Важные файлы и шаблоны
----------------------
- `main.py` — точка входа: инициализация, ConversationHandler, регистрация handler'ов.
- `states.py` — константы состояний диалогов.
- `handlers/` — набор обработчиков:
  - `all_mp_remains_handler.py` — логика объединённого отчёта по всем МП.
  - `auto_report_handler.py` — интерфейс настройки автоотчётов.
  - `barcode_handler.py` — генерация штрихкодов и PDF‑этикеток.
  - `csv_converter_handler.py` — конвертер CSV → XLSX.
  - `ozon_remains_handler.py`, `ozon_sales_handler.py`, `wb_remains_handler.py`, `wb_sales_handler.py` — работа с API Ozon и Wildberries.
- `auto_reports.json` — хранит конфигурации автоотчётов.
- `Шаблон выгрузки остатков всех МП.xlsx` — шаблон, который копируется и заполняется в объединённом отчёте. Файл обязателен для работы соответствующего handler'а.
- `arial.ttf` — шрифт для корректного отображения русского текста в PDF (используется reportlab). Если его нет — бот будет использовать стандартный шрифт.

Рекомендации и известные ограничения
-----------------------------------
- PicklePersistence хранит данные диалогов в `bot_conversation_data.pkl`. Pickle чувствителен к изменениям кода и небезопасен при переносе между машинами/версиями Python. Для долгосрочного использования рекомендуется перейти на DB‑хранилище.
- Некоторые вызовы к API (в частности — методы получения остатков Wildberries) выполняются синхронно внутри async функций. Это может блокировать event loop при медленных API. Рекомендуется перемещать синхронные запросы в ThreadPoolExecutor или использовать асинхронный HTTP‑клиент.
- Шаблон Excel (`Шаблон выгрузки остатков всех МП.xlsx`) обязателен — если его нет, генерация объединённого отчёта упадёт.
- Библиотека `code128` — опциональна. Если она отсутствует, бот сгенерирует этикетки без встроенного изображения штрихкода.
- Убедитесь, что `BOT_TOKEN` в `.env` не попадает в VCS.
  - Pillow (PIL)
  - code128 (опционально, для рендеринга штрихкодов)
- Файлы-шаблоны (см. раздел "Важные файлы и шаблоны").
